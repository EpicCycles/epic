{% extends 'epic/base.html' %}
{% load staticfiles %}
{% load static %}
{% block content %}
    <h2>Quote</h2>
    <form action="" method="post" id="quote_form">
        {% csrf_token %}

        <input type="hidden" name="form_action" id="form_action" value="create_quote"/>
        <section class="flex-vertical">
            <div id="core-data">
                <section class="row">
                    <div>
                        {% if quote %}
                            <p><strong>{{ quote.customer }}</strong></p>
                            {% if quote.is_bike %}
                                <p><strong>{{ quote.frame }}</strong></p>
                                {% if quote.frame.description %}
                                    <p>{{ quote.frame.description }}</p>
                                {% endif %}
                                {% if quote.frame.colour %}
                                    <p><strong>Available Colours: </strong>{{ quote.frame.colour }}</p>
                                {% endif %}
                                {% if quote.frame.sizes %}
                                    <p><strong>Available Sizes: </strong>{{ quote.frame.sizes }}</p>
                                {% endif %}
                                {% if quote.frame.archived %}
                                    <p class="red"><strong>Archived: </strong>{{ quote.frame.archived_date }}</p>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <h3>Customer</h3>
                            {% if customer %}
                                {{ customer }}
                                {% for address in customer_addresses %}
                                    <br/>
                                    {{ address }}
                                {% endfor %}
                                {% for phone in customer_phones %}
                                    <br/>
                                    {{ phone }}
                                {% endfor %}
                                <br/>
                                <input type="button"
                                       onclick="popupDetail('{% url 'select_customer' %}','Change Customer')"
                                       class="button" value="Change Customer"/>
                            {% else %}
                                <input type="button"
                                       onclick="popupDetail('{% url 'select_customer' %}','Select Customer')"
                                       class="button" value="Select Customer"/>
                            {% endif %}

                            <a href="{% url 'add_customer' %}" class="button">Create New Customer</a>
                            <input type="hidden" name="new_customer_id" id="new_customer_id" value=""/>
                        {% endif %}

                        {% if quote %}
                            <p><strong>Total Price (pre discount): £</strong>{{ quote.sell_price }}</p>
                        {% endif %}
                    </div>
                    <div>
                        {% include "epic/common/form_as_table.html" with form=quote_form %}
                        {% if not quote %}
                            {% with "flex-vertical" as section_class %}
                                {% include "epic/frames/frame_select.html" %}
                            {% endwith %}
                        {% endif %}
                    </div>

                    {% if quote and quote.is_bike %}
                        <div >
                            <h4>Fitting Details</h4>
                            {% if customerFittings %}
                                <select name='id_fitting' id='id_fitting' title="select existing fitting to use">
                                    <option value="">No Fitting</option>
                                    {% for fitting in customerFittings %}
                                        <option value="{{ fitting.id }}" {% if quote.fitting == fitting %}
                                                selected {% endif %}>{{ fitting }}</option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                <strong>Self Sized</strong>
                            {% endif %}
                            <h4>New Fitting</h4>
                            {% include "epic/common/form_as_table.html" with form=fittingForm %}
                        </div>
                    {% endif %}
                    <div>
                        {% include "epic/notes/add_notes.html" %}
                    </div>
                </section>
            </div>
            <section class="row">

                {% if bike_summary %}
                    <div id="bike_summary">
                        <h3>Bike Summary</h3>
                        {% for line in bike_summary %}
                            <span id="bike_{{ forloop.counter }}" class="red">{{ line }}</span><br/>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if quote %}
                    <div class="flex-vertical">
                        <div>
                            <input type="button"
                                   onclick="popupDetail('{% url 'add_quote_part' pk=quote.pk %}','Add part to quote')"
                                   class="button" value="Add part to quote"/>
                        </div>
                        <div id="quote_parts">

                            <table id="quote_part_table">
                                <tr>
                                    <th class="listHead">Part Type</th>
                                    <th class="listHead">Brand</th>
                                    <th class="listHead">Part Name</th>
                                    <th class="listHead">Quantity</th>
                                    <th class="listHead">Price (£)</th>
                                    {% if quote.is_bike %}
                                        <th class="listHead">Spec Change</th>
                                        <th class="listHead">Trade In (£)</th>{% endif %}
                                    <th class="listHead">Other Info</th>
                                    <th class="listHead">Action</th>
                                </tr>
                                {% for part_form, part_attributes in quote_parts %}
                                    {% cycle 'row1' 'row2' as rowcolors silent %}
                                    <tr id="row_{{ forloop.counter }}" class="{{ rowcolors }}">
                                        {% for field in part_form.visible_fields %}
                                            {% include "epic/common/field_as_td.html"  with field=field %}
                                        {% endfor %}
                                        <td>
                                            <table>
                                                {% for quotePartAttributeForm in part_attributes %}
                                                    <section class="{{ rowcolors }}">
                                                        <div>
                                                            {{ quotePartAttributeForm.attribute_name.value }} :&nbsp;
                                                            {% for hidden in quotePartAttributeForm.hidden_fields %}
                                                                {{ hidden }}
                                                            {% endfor %}
                                                        </div>
                                                        {% include "epic/common/field_as_div.html"  with field=quotePartAttributeForm.attribute_value divClass="attributes" %}
                                                    </section>
                                                {% endfor %}
                                            </table>

                                        </td>
                                        <td class="align_center">
                                            <i class="material-icons red "
                                               onclick="removeRow('row_{{ forloop.counter }}')">delete_forever</i>
                                            {% for hidden in part_form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>

                    </div>
                {% endif %}
            </section>
        </section>
        {% include "epic/common/form_standard_actions.html" %}
        {% if quote %}
            {% if quote.can_be_issued %}
                <a href="{% url 'quote_issue' pk=quote.pk %}" title="View summary and Issue quote">
                    <i class="material-icons red ">publish</i></a>
            {% endif %}
            <a href="{% url 'copy_quote' pk=quote.pk %}" title="copy to new quote for same customer">
                <i class="material-icons red ">file_copy</i></a>
            {% if quote.is_bike %}
                <a onclick="copyWithNewBikeOrCustomer('{% url 'bike_select_popup' %}',{{ quote.pk }})"
                     title="Select new bike from popup and create quote with that bike instead of current bike.">
                    <i class="material-icons red ">directions_bike</i></a>
                <a onclick="copyWithNewBikeOrCustomer('{% url 'select_customer' %}',{{ quote.pk }})"
                     title="Select new customer from popup and create quote for that customer with this quote as start.">
                    <i class="material-icons red ">account_box</i></a>
            {% endif %}
        {% else %}
            <script src="{% static 'js/quotes/quote_initial.js' %}"></script>
        {% endif %}
    </form>
    {% include "epic/notes/notes_display.html" %}

    <!-- hidden form for creating a new quote -->
    {% include "epic/quotes/quote_copy_with_changes.html" %}

    <!-- quote javascript plus quote button actions for copy with new customer or bike -->
    <script src="{% static 'js/quotes/quote.js' %}"></script>
    <script src="{% static 'js/quotes/quote_buttons.js' %}"></script>
{% endblock %}
